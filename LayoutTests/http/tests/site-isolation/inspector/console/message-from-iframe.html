<script src="/inspector/resources/inspector-test.js"></script>
<script>
    // Utilities for page code.
    function addIFrame(url, id) {
        const iframe = document.createElement("iframe");
        iframe.src = url;
        iframe.onload = () => console.log(`iframe ${id} is loaded in ${location.href}`);
        document.body.appendChild(iframe);
    }

    function test() {
        // The purpose of these tests are to test that Web Inspector should receive console messages generated from various iframe tree correctly.

        const suite = InspectorTest.createAsyncSuite("MessageFromIFrame");

        // Utilities for test code.
        let callback = () => {};
        WI.consoleManager.addEventListener(WI.ConsoleManager.Event.MessageAdded, (event) => {
            let { target: { type }, messageText } = event.data.message;
            InspectorTest.log(`Got message from ${type} target: ${messageText}`);
            callback();
        });

        function runMessageTest(resolve, expected, func) {
            let seen = 0;

            callback = () => {
                if (++seen === expected)
                    resolve();
            };

            InspectorTest.evaluateInPage(func);
        }

        suite.addTestCase({
            name: "MessageFromIFrame.SameOriginIFrame",
            description: "console message coming from same origin iframe",
            test: (resolve) => runMessageTest(resolve, 4, `addIFrame("resources/console-messages.html", 0)`),
        });

        // FIXME <https://webkit.org/b/307733>: Additional work needed to make this test work.
        /* suite.addTestCase({
            name: "MessageFromIFrame.CrossOriginIFrame",
            description: "console message coming from cross origin iframe",
            test: (resolve) => runMessageTest(resolve, 4, `addIFrame("http://localhost:8000/inspector/console/resources/console-messages.html", 1)`),
        }); */

        suite.addTestCase({
            name: "MessageFromIFrame.GrandChildSameOriginIFrameInSameOrigin",
            description: "console message coming from same origin grand-child iframe in same origin iframe",
            test: (resolve) => runMessageTest(resolve, 5, `addIFrame("resources/embedded-same-origin.html", 2)`),
        });

        // FIXME <https://webkit.org/b/307733>: Additional work needed to make this test work.
        /* suite.addTestCase({
            name: "MessageFromIFrame.GrandChildSameOriginIFrameInCrossOrigin",
            description: "console message coming from same origin grand-child iframe in cross origin iframe",
            test: (resolve) => runMessageTest(resolve, 5, `addIFrame("http://localhost:8000/inspector/console/resources/embedded-cross-origin.html", 3)`),
        }); */

        suite.runTestCasesAndFinish();
    }
</script>

<body onload="runTest()"></body>
