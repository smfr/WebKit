<script>
 testRunner?.dumpAsText();
    (async () => {
        globalThis.testRunner?.waitUntilDone();

        const databaseName = 'db2';
        const objectStoreName = 'os0';
        const databases = await indexedDB.databases();

        function transactionHelper(transaction) {
            let theOs = transaction.objectStore(objectStoreName);
            let addRequest = theOs.add(undefined, 1);
            for (let i = 20; i; i--) {
                addRequest.addEventListener('success', ev => {
                    let transaction = ev.target.transaction;
                    transactionHelper(transaction);
                });
            }
            addRequest.addEventListener('success', ev => {
                let transaction = ev.target.transaction;
                transactionHelper(transaction);
                transaction.commit();
            });
        }

        indexedDB.open(databaseName, 1).addEventListener('upgradeneeded', ev => {
           let db = ev.target.result;
           let txn = ev.target.transaction;
           if (!txn.objectStoreNames.contains(objectStoreName)) db.createObjectStore(objectStoreName, {});
        });
        navigator.mediaSession.playbackState = 'playing';
        await navigator.locks.request('', () => {})
        indexedDB.open(databaseName, 1).addEventListener('success', ev => {
            let db = ev.target.result;
            let transaction = db.transaction([objectStoreName], 'readwrite');
            transactionHelper(transaction);
        });
        await navigator.locks.request('', () => {});

        globalThis.testRunner?.notifyDone();
    })();
</script>
<div>
    This test passes if it doesn't crash.
</div>
